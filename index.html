<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T.A.L.O.S. FINAL</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    
    <style>
        body { 
            background-color: #0d0d0d; color: #ff9900; 
            font-family: 'Courier New', monospace; 
            display: flex; flex-direction: column; 
            height: 100vh; margin: 0; overflow: hidden; 
            text-transform: uppercase;
        }

        /* NAVIGATION */
        .nav-bar {
            display: flex; width: 100%; justify-content: space-around;
            padding: 15px 0; background: #000; border-bottom: 1px solid #333;
            flex-shrink: 0; z-index: 10;
        }
        .nav-btn {
            background: none; border: 1px solid #333; color: #555;
            padding: 10px 30px; font-weight: bold; cursor: pointer;
        }
        .nav-btn.active { border-color: #ff9900; color: #ff9900; background: rgba(255,153,0,0.1); }

        /* MAIN LAYOUT */
        .view-section { display: none; flex-grow: 1; width: 100%; flex-direction: column; }
        .view-section.active { display: flex; }

        /* INPUT AREA */
        .input-container {
            flex-grow: 1; display: flex; align-items: center; justify-content: center;
        }
        .record-btn {
            width: 150px; height: 150px; border-radius: 50%; background: transparent;
            border: 5px solid #ff9900; color: #ff9900; font-size: 1.5rem; font-weight: bold;
            cursor: pointer; box-shadow: 0 0 25px #ff9900; transition: 0.2s;
        }
        .record-btn:active, .record-btn.active { background: #ff9900; color: #000; }

        /* LOG TERMINAL */
        .log-terminal { 
            width: 100%; height: 40%; 
            background: #000; border-top: 2px solid #333;
            padding: 20px; box-sizing: border-box;
            color: #888; font-size: 0.85rem; 
            overflow-y: auto; text-align: left; line-height: 1.6;
        }
        .log-entry { margin-bottom: 8px; border-bottom: 1px solid #1a1a1a; }

        /* DATA LIST */
        .data-list { width: 100%; height: 100%; overflow-y: auto; padding: 10px; box-sizing: border-box;}
        .server-entry { border: 1px solid #333; padding: 15px; margin-bottom: 10px; background: #050505; }
        .server-date { color: #555; font-size: 0.8rem; margin-bottom: 5px; }
        .server-item { color: #ff9900; font-size: 1.1rem; }
        .loading { text-align: center; color: #444; margin-top: 50px; }
    </style>
</head>
<body>

    <div class="nav-bar">
        <button class="nav-btn active" onclick="switchView('input')">RECORD</button>
        <button class="nav-btn" onclick="switchView('data')">LOGS</button>
    </div>

    <div id="view-input" class="view-section active">
        <div class="input-container">
            <button class="record-btn" id="recBtn" onclick="startSequence()">REC</button>
        </div>
        <div class="log-terminal" id="localLog">
            <div class="log-entry">> SYSTEM READY.</div>
            <div class="log-entry">> CHANNEL: SECURE.</div>
        </div>
    </div>

    <div id="view-data" class="view-section">
        <div id="serverDataList" class="data-list"></div>
    </div>

    <script>
      // --- THE NEW CORRECT URL ---
      const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyqEh1q7PJPsmYsn_Ng_h5PbmMVqaDfm9XKzfJr0ge33V0UYd0iD_ZwxvCQmKDnLzKEmw/exec";
      // ---------------------------

      const localLog = document.getElementById('localLog');
      const serverDataList = document.getElementById('serverDataList');
      const recBtn = document.getElementById('recBtn');

      function log(msg) {
        localLog.innerHTML = `<div class="log-entry">> ${msg}</div>` + localLog.innerHTML;
      }

      function switchView(viewName) {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
        document.getElementById('view-' + viewName).classList.add('active');
        if(viewName === 'data') fetchLogsJSONP();
      }

      // --- JSONP FETCH LOGIC ---
      function fetchLogsJSONP() {
        serverDataList.innerHTML = '<div class="loading">ESTABLISHING UPLINK...</div>';
        
        // Create unique callback name
        const callbackName = 'talos_' + Date.now();
        
        // Define handling function
        window[callbackName] = function(data) {
            displayLogs(data);
            // Cleanup
            delete window[callbackName];
            const oldScript = document.getElementById(callbackName);
            if(oldScript) oldScript.remove();
        };

        // Create script tag
        const script = document.createElement('script');
        script.id = callbackName;
        script.src = SCRIPT_URL + '?callback=' + callbackName + '&action=read&t=' + Date.now();
        
        script.onerror = () => {
             serverDataList.innerHTML = '<div class="loading" style="color:red">CONNECTION FAILED<br>1. Check "New Version" Deployment<br>2. Verify URL</div>';
        };
        
        document.body.appendChild(script);
      }

      function displayLogs(data) {
        if (!data || data.length === 0) {
             serverDataList.innerHTML = '<div class="loading">NO LOGS FOUND</div>';
             return;
        }
        let html = "";
        data.forEach(row => {
            html += `
            <div class="server-entry">
                <div class="server-date">${row.date} | ${row.time}</div>
                <div class="server-item">${row.item}</div>
            </div>`;
        });
        serverDataList.innerHTML = html;
      }

      // VOICE INPUT
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

      window.startSequence = function() {
        if (!SpeechRecognition) { log("Mic Not Supported"); return; }
        const recognition = new SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.continuous = false;

        recognition.onstart = () => { recBtn.classList.add("active"); log("Listening..."); };
        recognition.onend = () => { recBtn.classList.remove("active"); };

        recognition.onresult = async (event) => {
            const text = event.results[0][0].transcript;
            log(`Heard: "${text}"`);
            await sendData(text);
        };
        recognition.start();
      };

      async function sendData(text) {
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-CA');
        const timeStr = now.toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'});

        try {
            log("Sending...");
            await fetch(SCRIPT_URL, {
                method: "POST", mode: "no-cors", 
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ item: text, date: dateStr, time: timeStr })
            });
            log(`SAVED: ${timeStr}`);
        } catch (e) {
            log("UPLOAD FAIL");
        }
      }
    </script>
</body>
</html>
