<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T.A.L.O.S.</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    
    <style>
        /* CORE STYLES */
        body { 
            background-color: #0d0d0d; color: #ff9900; 
            font-family: 'Courier New', monospace; 
            display: flex; flex-direction: column; align-items: center; 
            height: 100vh; margin: 0; overflow: hidden; text-transform: uppercase;
        }

        /* HEADER */
        .nav-bar {
            display: flex; width: 100%; justify-content: space-around;
            padding: 20px 0; border-bottom: 1px solid #333;
            background: #000; z-index: 10;
        }
        .nav-btn {
            background: none; border: 1px solid #444; color: #666;
            padding: 10px 20px; font-family: inherit; font-weight: bold;
            cursor: pointer;
        }
        .nav-btn.active { border-color: #ff9900; color: #ff9900; box-shadow: 0 0 10px rgba(255,153,0,0.3); }

        /* VIEWS */
        .view-section { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; }
        .view-section.active { display: flex; }

        /* INPUT VIEW */
        .record-btn {
            width: 140px; height: 140px; border-radius: 50%; background: transparent;
            border: 4px solid #ff9900; color: #ff9900; font-size: 1.5rem; font-weight: bold;
            cursor: pointer; box-shadow: 0 0 20px #ff9900; margin-bottom: 20px;
        }
        .record-btn:active { background: #ff9900; color: #000; }
        .status-box { font-size: 1.2rem; margin-bottom: 20px; font-weight: bold; }

        /* DATA VIEW */
        .data-list {
            width: 90%; height: 80%; overflow-y: auto; text-align: left; padding: 10px;
        }
        .entry {
            border-bottom: 1px solid #333; padding: 10px 0; margin-bottom: 5px;
        }
        .entry-time { color: #666; font-size: 0.7rem; }
        .entry-item { color: #ff9900; font-size: 0.9rem; margin-top: 2px; }
        .loading { text-align: center; color: #444; margin-top: 50px; }

    </style>
</head>
<body>

    <div class="nav-bar">
        <button class="nav-btn active" onclick="switchView('input')">INPUT</button>
        <button class="nav-btn" onclick="switchView('data')">LOGS</button>
    </div>

    <div id="view-input" class="view-section active">
        <div id="status" class="status-box">READY</div>
        <button class="record-btn" id="recBtn" onclick="startSequence()">REC</button>
    </div>

    <div id="view-data" class="view-section">
        <div id="dataList" class="data-list"></div>
    </div>

    <script>
      const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyq2ckVg417ZxYg8uld5OHsNeuhe9ezv03G6lcg8NqCfEpd1hzaVMIi7NPRkUp5DM4-mw/exec";
      
      const status = document.getElementById('status');
      const dataList = document.getElementById('dataList');
      const recBtn = document.getElementById('recBtn');

      // --- NAVIGATION LOGIC ---
      function switchView(viewName) {
        // Toggle Buttons
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');

        // Toggle Sections
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
        document.getElementById('view-' + viewName).classList.add('active');

        // If Data view, load data
        if(viewName === 'data') fetchLogs();
      }

      // --- DATA RETRIEVAL ---
      async function fetchLogs() {
        dataList.innerHTML = '<div class="loading">DOWNLOADING TELEMETRY...</div>';
        try {
            // Add timestamp to prevent caching
            const response = await fetch(SCRIPT_URL + "?t=" + new Date().getTime());
            const data = await response.json();
            
            let html = "";
            data.forEach(row => {
                html += `
                <div class="entry">
                    <div class="entry-time">${row.date} | ${row.time}</div>
                    <div class="entry-item">${row.item}</div>
                </div>`;
            });
            dataList.innerHTML = html || '<div class="loading">NO DATA FOUND</div>';
        } catch (e) {
            dataList.innerHTML = '<div class="loading">CONNECTION ERROR</div>';
        }
      }

      // --- VOICE INPUT LOGIC (SAME AS BEFORE) ---
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

      window.startSequence = function() {
        if (!SpeechRecognition) { alert("NO MIC SUPPORT"); return; }
        const recognition = new SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.continuous = false;

        recognition.onstart = () => { 
            status.innerText = "RECORDING..."; 
            recBtn.classList.add("active");
        };
        
        recognition.onend = () => {
            recBtn.classList.remove("active");
            if (status.innerText === "RECORDING...") status.innerText = "READY";
        };

        recognition.onresult = async (event) => {
            const text = event.results[0][0].transcript;
            status.innerText = "UPLOADING...";
            await sendData(text);
        };
        recognition.start();
      };

      async function sendData(text) {
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-CA');
        const timeStr = now.toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'});

        try {
            await fetch(SCRIPT_URL, {
                method: "POST", mode: "no-cors", 
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ item: text, date: dateStr, time: timeStr })
            });
            status.innerText = "SECURED";
            setTimeout(() => { status.innerText = "READY"; }, 2000);
        } catch (e) {
            status.innerText = "ERROR";
        }
      }
    </script>
</body>
</html>
